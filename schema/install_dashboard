set names utf8;
create database if not exists ustudy character set utf8;

CREATE TABLE if not exists ustudy.subject (
  id int(11) NOT NULL AUTO_INCREMENT,
  name varchar(20) DEFAULT NULL,
  type varchar(1) DEFAULT '0' COMMENT '是否分科，0：不分科，1：文综，2：理综',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8;

create table if not exists ustudy.users (
id INT NOT NULL AUTO_INCREMENT,
loginname varchar(32) NOT NULL,
fullname varchar(32) NOT NULL,
passwd varchar(32) NOT NULL,
ugroup ENUM ('运维', '市场', '代理商', '临时') NOT NULL,
ctime datetime DEFAULT NULL,
ll_time datetime DEFAULT NULL,
status ENUM ('在线', '离线'),
province varchar(32) NOT NULL,
city varchar(32) NOT NULL,
district varchar(32) NOT NULL,
UNIQUE KEY (loginname),
PRIMARY KEY (id)
) ENGINE=InnoDB;

create table if not exists ustudy.roles (
id INT NOT NULL AUTO_INCREMENT,
role_name varchar(32) NOT NULL,
user_name varchar(32) NOT NULL,
INDEX(user_name),
PRIMARY KEY (id),
FOREIGN KEY (user_name)
    REFERENCES ustudy.users(loginname)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

create table if not exists ustudy.perms (
id INT NOT NULL AUTO_INCREMENT,
perm varchar(64) NOT NULL,
role_name varchar(32) NOT NULL,
INDEX (role_name),
PRIMARY KEY(id)
) ENGINE=InnoDB;

create table if not exists ustudy.orgowner (
id INT NOT NULL AUTO_INCREMENT,
name varchar(32) NOT NULL,
loginname varchar(32) NOT NULL,
passwd varchar(32) NOT NULL,
orgtype ENUM ('学校','教研室') NOT NULL,
orgid varchar(32) NOT NULL,
role ENUM('校长','考务老师','教研主任') NOT NULL,
ctime datetime DEFAULT NULL,
PRIMARY KEY(id),
INDEX(name,loginname)
) ENGINE=InnoDB;

create table if not exists ustudy.school (
id INT NOT NULL AUTO_INCREMENT,
schid  VARCHAR(32) NOT NULL,
schname VARCHAR(128) NOT NULL,
type ENUM('高中', '初中', '完中', '九年制', '小学', '十二年制', '补习', '其他') NOT NULL,
province  VARCHAR(32) NOT NULL,
city      VARCHAR(32) NOT NULL,
district  VARCHAR(32) NOT NULL,
PRIMARY KEY (id),
INDEX(schname, schid),
UNIQUE KEY (schid)
) ENGINE=InnoDB;

create table if not exists ustudy.teacher (
id INT NOT NULL AUTO_INCREMENT,
teacid VARCHAR(32) NOT NULL,
teacname VARCHAR(32) NOT NULL,
passwd VARCHAR(32) NOT NULL,
orgtype ENUM ('学校','教研室') NOT NULL,
orgid VARCHAR(32) NOT NULL,
ctime datetime DEFAULT NULL,
ll_time datetime DEFAULT NULL,
PRIMARY KEY(id),
INDEX (teacid, orgid),
UNIQUE KEY(teacid)
) ENGINE=InnoDB;

create table if not exists ustudy.grade (
id INT NOT NULL AUTO_INCREMENT,
grade_name VARCHAR(32) NOT NULL,
classes_num INT NOT NULL,
grade_owner VARCHAR(32),
schid VARCHAR(32) NOT NULL,
PRIMARY KEY(id),
INDEX(schid, grade_name),
FOREIGN KEY (schid)
    REFERENCES ustudy.school(schid)
    ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (grade_owner)
    REFERENCES ustudy.teacher(teacid)
    ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB;

create table if not exists ustudy.gradesub (
id INT NOT NULL AUTO_INCREMENT,
sub_name VARCHAR(32) NOT NULL,
grade_id INT NOT NULL,
sub_owner VARCHAR(32),
PRIMARY KEY(id),
INDEX(grade_id, sub_name),
FOREIGN KEY (grade_id)
    REFERENCES ustudy.grade(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (sub_owner)
    REFERENCES ustudy.teacher(teacid)
    ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB;

create table if not exists ustudy.exam (
id INT NOT NULL AUTO_INCREMENT,
exam_name VARCHAR(64) NOT NULL,
exam_date date NOT NULL,
type ENUM('校考','联考') NOT NULL,
status enum('0','1','2','3') NOT NULL DEFAULT '0',
PRIMARY KEY(id),
INDEX(exam_name, exam_date),
UNIQUE KEY (exam_name)
) ENGINE=InnoDB;

create table if not exists ustudy.examschool (
id INT NOT NULL AUTO_INCREMENT,
examid INT NOT NULL,
schid VARCHAR(32) NOT NULL,
schname VARCHAR(128) NOT NULL,
PRIMARY KEY (id),
INDEX(examid, schid, schname),
FOREIGN KEY (examid)
    REFERENCES ustudy.exam(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (schid)
    REFERENCES ustudy.school(schid)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

create table if not exists ustudy.examgradesub (
id INT NOT NULL AUTO_INCREMENT,
examid INT NOT NULL,
exam_name VARCHAR(64) NOT NULL,
grade_id INT NOT NULL,
grade_name varchar(32) NOT NULL,
sub_id int(11) NOT NULL,
sub_name VARCHAR(32) NOT NULL,
stu_num INT default 0,
teac_num INT default 0,
exam_paper BOOL default false,
exam_answer BOOL default false,
exam_paper_num INT default 0,
template BOOL default false,
obj_item_num INT default 0,
sub_item_num INT default 0,
task_dispatch BOOL default false,
answer_seted varchar(1) DEFAULT '0' COMMENT '标准答案是否设置',
upload_bath_count int(11) DEFAULT '10' COMMENT '批量上传数量',
blank_answer_paper varchar(360) DEFAULT NULL COMMENT '空白答题卡图片地址',
blank_questions_paper varchar(360) DEFAULT NULL COMMENT '空白试卷图片地址',
xml_server_path varchar(50) DEFAULT NULL COMMENT '模板数据文件阿里云地址',
original_data blob COMMENT '原始json数据',
PRIMARY KEY (id),
INDEX (grade_id, grade_name),
FOREIGN KEY (examid)
    REFERENCES ustudy.exam(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY (grade_id)
    REFERENCES ustudy.grade(id)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;


